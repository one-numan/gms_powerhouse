{% extends "base.html" %}

{% block title %}
{{ page_title }}
{% endblock %}

{% block content %}

<div class="pagetitle">
  <h1>{{ page_title }}</h1>
</div>

<section class="section">
  <div class="container-fluid">

    <div class="card">
      <div class="card-body">

        <!-- ========================= -->
        <!-- Header -->
        <!-- ========================= -->
        <div class="d-flex flex-column flex-md-row
                    justify-content-between align-items-md-center
                    gap-2 mb-3">
          <h5 class="card-title mb-0">Subscription Expiry</h5>

          {% if period == "today" %}
            <span class="badge bg-danger fs-6">Expiring Today</span>
          {% elif period == "tomorrow" %}
            <span class="badge bg-warning text-dark fs-6">Expiring Tomorrow</span>
          {% elif period == "last_7_days" %}
            <span class="badge bg-secondary fs-6">Expired (Last 7 Days)</span>
          {% else %}
            <span class="badge bg-primary fs-6">All</span>
          {% endif %}
        </div>

        <!-- ========================= -->
        <!-- Search & Filters -->
        <!-- ========================= -->
        <form method="get" class="mb-3">

          <!-- Search -->
          <div class="input-group mb-2">
            <input type="text"
                   name="q"
                   class="form-control"
                   placeholder="Search member, mobile, plan"
                   value="{{ request.GET.q }}">
            <button class="btn btn-outline-primary" type="submit">
              <i class="bi bi-search"></i>
            </button>
          </div>

          <!-- Filters -->
          <div class="row g-2">

            <!-- Status -->
            <div class="col-6 col-md-3">
              <select name="status" class="form-select">
                <option value="">Status</option>
                {% for key,label in status_choices %}
                  <option value="{{ key }}"
                    {% if request.GET.status == key %}selected{% endif %}>
                    {{ label }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <!-- Date range -->
            <div class="col-6 col-md-3">
              <input type="date"
                     name="start"
                     class="form-control"
                     value="{{ request.GET.start }}">
            </div>

            <div class="col-6 col-md-3">
              <input type="date"
                     name="end"
                     class="form-control"
                     value="{{ request.GET.end }}">
            </div>

          </div>
        </form>

        <!-- ========================= -->
        <!-- Subscriptions Table -->
        <!-- ========================= -->
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle">
        
            <thead>
              <tr>
                <th>End Date</th>
                <th>Member</th>
                <th class="d-none d-md-table-cell">Plan</th>
                <th class="d-none d-md-table-cell">Mobile</th>
                <th>Status</th>
                <th class="text-center">WhatsApp</th>
              </tr>
            </thead>
        
            <tbody>
              {% for sub in subscriptions %}
              <tr>
                <!-- End Date -->
                <td>
                  {{ sub.end_date }}
                  {% if sub.end_date == today %}
                    <span class="badge bg-danger ms-1">Today</span>
                  {% elif sub.end_date == tomorrow %}
                    <span class="badge bg-warning text-dark ms-1">Tomorrow</span>
                  {% endif %}
                </td>
        
                <!-- Member -->
                <td>
                  {{ sub.member.first_name }} {{ sub.member.last_name }}
        
                  <!-- Mobile view extra info -->
                  <div class="d-md-none small text-muted">
                    {{ sub.plan.name }}<br>
                    ðŸ“ž {{ sub.member.mobile }}
                  </div>
                </td>
        
                <!-- Plan (Desktop only) -->
                <td class="d-none d-md-table-cell">
                  {{ sub.plan.name }}
                </td>
        
                <!-- Mobile (Desktop only) -->
                <td class="d-none d-md-table-cell">
                  {{ sub.member.mobile }}
                </td>
        
                <!-- Status -->
                <td>
                  {% if sub.status == "active" %}
                    <span class="badge bg-success">Active</span>
                  {% elif sub.status == "expired" %}
                    <span class="badge bg-secondary">Expired</span>
                  {% else %}
                    <span class="badge bg-danger">Cancelled</span>
                  {% endif %}
                </td>
        
                <!-- WhatsApp -->
                <td class="text-center">
                  {% if sub.member.mobile %}
                    <a
                      href="https://wa.me/91{{ sub.member.mobile }}?text=Hi%2C%20your%20membership%20has%20expired.%20Please%20renew."
                      target="_blank"
                      class="btn btn-success btn-sm"
                      title="Send WhatsApp"
                    >
                      <i class="bi bi-whatsapp"></i>
                    </a>
                  {% else %}
                    <span class="text-muted">â€”</span>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" class="text-center text-muted">
                  No subscriptions found.
                </td>
              </tr>
              {% endfor %}
            </tbody>
        
          </table>
        </div>
        

        <!-- ========================= -->
        <!-- Pagination -->
        <!-- ========================= -->
        {% if subscriptions.has_other_pages %}
        <nav class="mt-3" aria-label="Subscription pagination">
          <ul class="pagination justify-content-center flex-wrap">

            {% if subscriptions.has_previous %}
              <li class="page-item">
                <a class="page-link"
                   href="?page={{ subscriptions.previous_page_number }}&{{ request.GET.urlencode|cut:'page=' }}">
                  Previous
                </a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">Previous</span>
              </li>
            {% endif %}

            {% for num in subscriptions.paginator.page_range %}
              {% if num == subscriptions.number %}
                <li class="page-item active">
                  <span class="page-link">{{ num }}</span>
                </li>
              {% elif num >= subscriptions.number|add:'-2' and num <= subscriptions.number|add:'2' %}
                <li class="page-item">
                  <a class="page-link"
                     href="?page={{ num }}&{{ request.GET.urlencode|cut:'page=' }}">
                    {{ num }}
                  </a>
                </li>
              {% endif %}
            {% endfor %}

            {% if subscriptions.has_next %}
              <li class="page-item">
                <a class="page-link"
                   href="?page={{ subscriptions.next_page_number }}&{{ request.GET.urlencode|cut:'page=' }}">
                  Next
                </a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">Next</span>
              </li>
            {% endif %}

          </ul>
        </nav>
        {% endif %}

      </div>
    </div>

  </div>
</section>

{% endblock %}
